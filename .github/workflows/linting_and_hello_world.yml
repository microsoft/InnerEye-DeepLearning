name: Flake8, MyPy, and Hello World

# This workflow runs linting via Flake8 and Mypy.
# It also checks that the HelloWorld model can be trained.

on:
  pull_request:
jobs:
  check:
    runs-on: [ubuntu-latest, windows-latest]
    steps:
      - uses: actions/checkout@v2
      - name: Add conda to PATH
        run: |
          if [ $(Agent.OS) = 'Windows_NT' ]
          then subdir=Scripts
          else subdir=bin
          fi
          echo "Adding this directory to PATH: $CONDA/$subdir"
          echo "##vso[task.prependpath]$CONDA/$subdir"
        shell: bash

      - name: Print conda version and initial package list
        run: |
          conda install conda=4.8.3 -y
          conda --version
          conda list
        shell: bash

      - name: Take ownership of conda installation
        run: |
          sudo chown -R $USER /usr/share/miniconda
        if: ${{runner.os == "Linux"}}

      - name: Create conda environment
        run: |
          conda env create --file environment.yml --name InnerEye --quiet
          source activate InnerEye
          echo Storing environment for later use by ComponentGovernance
          # This file is picked up later by ComponentGovernance
          pip freeze > requirements.txt
          echo Environment has been created with these packages:
          cat requirements.txt
        shell: bash

      - name: flake8
        run: |
          source activate InnerEye
          flake8
        shell: bash

      - name: mypy
        run: |
          source activate InnerEye
          python mypy_runner.py
        shell: bash

      - name: Run HelloWorld model
        run: |
          source activate InnerEye
          python ./InnerEye/ML/runner.py --model=HelloWorld
        env:
          PYTHONPATH: ${{ github.workspace }}
        shell: bash
